<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart AI Traffic Light Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .lane-card { transition: all 0.3s; border-left: 5px solid #ccc; }
        .lane-active { border-left-color: #28a745; background-color: #e8f5e9; }
        .traffic-light { width: 60px; height: 160px; background: #333; border-radius: 10px; padding: 10px; margin: 0 auto; display: flex; flex-direction: column; justify-content: space-between; align-items: center; }
        .light { width: 40px; height: 40px; border-radius: 50%; opacity: 0.3; transition: opacity 0.3s; }
        .red { background-color: #ff4444; }
        .yellow { background-color: #ffbb33; }
        .green { background-color: #00C851; }
        .light.active { opacity: 1; box-shadow: 0 0 15px currentColor; }
        .metric-value { font-size: 2rem; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container py-5">
        <header class="mb-5 text-center">
            <h1 class="display-4 fw-bold text-primary">ðŸš¦ Smart AI Traffic Dashboard</h1>
            <p class="lead text-muted">Real-time Traffic Monitoring & Control System</p>
            <div class="badge bg-secondary" id="last-updated">Waiting for data...</div>
        </header>

        <!-- Main Decision Display -->
        <div class="row mb-5 justify-content-center">
            <div class="col-md-8">
                <div class="card shadow-sm border-primary">
                    <div class="card-body text-center">
                        <h3 class="card-title">Current AI Decision</h3>
                        <div class="display-1 fw-bold text-success my-3" id="active-lane-display">--</div>
                        <p class="lead">Duration: <span id="duration-display" class="fw-bold">--</span> seconds</p>
                        <p class="text-muted" id="reason-display">Analyzing traffic...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lanes Grid -->
        <div class="row g-4">
            <!-- Lane 1 -->
            <div class="col-md-3">
                <div class="card lane-card h-100" id="card-lane1">
                    <div class="card-body text-center">
                        <h5>Lane 1</h5>
                        <div class="traffic-light mb-3">
                            <div class="light red" id="l1-red"></div>
                            <div class="light yellow" id="l1-yellow"></div>
                            <div class="light green" id="l1-green"></div>
                        </div>
                        <div class="metric-value" id="dist-lane1">--</div>
                        <small class="text-muted">Distance (cm)</small>
                    </div>
                </div>
            </div>

            <!-- Lane 2 -->
            <div class="col-md-3">
                <div class="card lane-card h-100" id="card-lane2">
                    <div class="card-body text-center">
                        <h5>Lane 2</h5>
                        <div class="traffic-light mb-3">
                            <div class="light red" id="l2-red"></div>
                            <div class="light yellow" id="l2-yellow"></div>
                            <div class="light green" id="l2-green"></div>
                        </div>
                        <div class="metric-value" id="dist-lane2">--</div>
                        <small class="text-muted">Distance (cm)</small>
                    </div>
                </div>
            </div>

            <!-- Lane 3 -->
            <div class="col-md-3">
                <div class="card lane-card h-100" id="card-lane3">
                    <div class="card-body text-center">
                        <h5>Lane 3</h5>
                        <div class="traffic-light mb-3">
                            <div class="light red" id="l3-red"></div>
                            <div class="light yellow" id="l3-yellow"></div>
                            <div class="light green" id="l3-green"></div>
                        </div>
                        <div class="metric-value" id="dist-lane3">--</div>
                        <small class="text-muted">Distance (cm)</small>
                    </div>
                </div>
            </div>

            <!-- Lane 4 -->
            <div class="col-md-3">
                <div class="card lane-card h-100" id="card-lane4">
                    <div class="card-body text-center">
                        <h5>Lane 4</h5>
                        <div class="traffic-light mb-3">
                            <div class="light red" id="l4-red"></div>
                            <div class="light yellow" id="l4-yellow"></div>
                            <div class="light green" id="l4-green"></div>
                        </div>
                        <div class="metric-value" id="dist-lane4">--</div>
                        <small class="text-muted">Distance (cm)</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function updateDashboard() {
            fetch('/api/dashboard-data')
                .then(response => response.json())
                .then(data => {
                    if (!data.success) return;

                    const sensor = data.sensor;
                    const decision = data.decision;

                    // Update Timestamp
                    document.getElementById('last-updated').textContent = 'Last Updated: ' + data.timestamp;

                    // Update Sensor Values
                    document.getElementById('dist-lane1').textContent = sensor.lane1 || '--';
                    document.getElementById('dist-lane2').textContent = sensor.lane2 || '--';
                    document.getElementById('dist-lane3').textContent = sensor.lane3 || '--';
                    document.getElementById('dist-lane4').textContent = sensor.lane4 || '--';

                    // Update Decision Info
                    const activeLane = decision.activeLane || 'None';
                    document.getElementById('active-lane-display').textContent = activeLane.toUpperCase();
                    document.getElementById('duration-display').textContent = decision.duration || '--';
                    document.getElementById('reason-display').textContent = decision.reason || 'Waiting for new decision...';

                    // Update Visuals (Lights & Cards)
                    ['lane1', 'lane2', 'lane3', 'lane4'].forEach(lane => {
                        const isGreen = (lane === activeLane);
                        
                        // Card Styling
                        const card = document.getElementById(`card-${lane}`);
                        if (isGreen) {
                            card.classList.add('lane-active');
                        } else {
                            card.classList.remove('lane-active');
                        }

                        // Lights
                        const prefix = lane.replace('lane', 'l'); // l1, l2...
                        const redLight = document.getElementById(`${prefix}-red`);
                        const greenLight = document.getElementById(`${prefix}-green`);
                        
                        // Simple logic: Active lane is Green, others Red
                        // (Yellow logic would require more complex state tracking on frontend or backend)
                        if (isGreen) {
                            redLight.classList.remove('active');
                            greenLight.classList.add('active');
                        } else {
                            redLight.classList.add('active');
                            greenLight.classList.remove('active');
                        }
                    });
                })
                .catch(err => console.error('Error fetching data:', err));
        }

        // Refresh every 2 seconds
        setInterval(updateDashboard, 2000);
        updateDashboard(); // Initial call
    </script>
</body>
</html>
